<h1>Статистика сайта russianpulse.ru</h1>

<h2>Сегодня</h2>
Пользователей на сайте: <%= Client.where("updated_at > ?", 5.minutes.ago).count %>
<br/>

Уникальных пользователей: <%= Client.today.count %>
<br/>

Просмотры: <%= PageView.today.count %>
<br/>

Среднее количество просмотров: <%= PageView.today.count.to_f / Session.today.count %>
<br/>

Сессии: <%= Session.today.count %>
<br/>

Средняя длительность сессии: <%= duration = Session.today.sum("updated_at - created_at"); parts = duration.split(":").map(&:to_f); (parts[0].hours + parts[1].minutes + parts[2].seconds).to_i / Session.today.count rescue 0 %> сек
<br/>

<h2>Просмотры по часам</h2>
<div id="chart_div">
  <% hours = PageView.today.group("cast(to_char(created_at, 'HH24') as int) + #{Time.now.utc_offset / 1.hour}").count %>

  <table border=1>
    <tr>
      <% (0..23).each do |hour| %>
        <th><%= hour %></th>
      <% end %>
    </tr>
    <tr>
      <% (0..23).each do |hour| %>
        <td><%= hours[hour] || 0 %></td>
      <% end %>
    </tr>
  </table>
</div>

<script type="text/javascript">
  google.load("visualization", "1", {packages:["corechart"]});
  google.setOnLoadCallback(drawChart);
  function drawChart() {
    <% hours = PageView.today.group("cast(to_char(created_at, 'HH24') as int) + #{Time.now.utc_offset / 1.hour}").count %>

    var rows = <%= raw (0..23).map { |h| [h.to_s, hours[h] || 0] }.to_json %>;

    var data = google.visualization.arrayToDataTable([
      ['Hours',  'Просмотры'],
    ].concat(rows));

    var options = {
      title: 'Просмотры за сегодя',
      vAxis: {title: 'Просмотры за час'},
      isStacked: true
    };

    var chart = new google.visualization.SteppedAreaChart(document.getElementById('chart_div'));

    chart.draw(data, options);
  }
</script>
